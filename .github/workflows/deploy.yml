name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE || '' }}
          timeout: 60s
          command_timeout: 900s
          script: |
            cd /opt/urlopy-v2
            
            # Zatrzymaj stary kontener
            docker-compose -f docker-compose.prod.yml down || true
            
            # Pobierz najnowszy kod z repozytorium (jeśli repo jest na VPS)
            if [ -d ".git" ]; then
              git pull origin master || true
            fi

      - name: Copy files to VPS using tar pipe
        run: |
          # Przygotuj klucz SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Skopiuj docker-compose.prod.yml
          cat docker-compose.prod.yml | ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT || 22 }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "cat > /opt/urlopy-v2/docker-compose.prod.yml"
          
          # Skopiuj folder prisma przez tar pipe
          tar czf - prisma/ | ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT || 22 }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "cd /opt/urlopy-v2 && tar xzf -"
          
          # Usuń klucz tymczasowy
          rm -f ~/.ssh/deploy_key

      - name: Build and start containers on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE || '' }}
          timeout: 60s
          command_timeout: 900s
          script: |
            cd /opt/urlopy-v2
            
            # Zbuduj obraz Docker na VPS
            docker-compose -f docker-compose.prod.yml build
            
            # Uruchom nowy kontener
            docker-compose -f docker-compose.prod.yml up -d
            
            # Wyczyść stare obrazy (opcjonalnie)
            docker image prune -f || true
            
            # Sprawdź status
            docker-compose -f docker-compose.prod.yml ps
            docker-compose -f docker-compose.prod.yml logs --tail=50
